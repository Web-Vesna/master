% layout 'default';
% title 'Welcome';

%= label_for login => 'Login'
%= input_tag login => 'test', id => 'login'
<br>
%= label_for pass => 'Password'
%= input_tag pass => 'password', id => 'pass'
<br>
%= javascript begin
    function load_roles() {
        var $s = $("#roles");
        $.get('/cgi-bin/roles', function (data) {
            if (!data.ok)
                return;
            $s.html('');
            for (var i = 0; i < data.count; ++i) {
                $s.append('<option value="' + data.roles[i].name + '">' + data.roles[i].name + '</option>');
            }
        });
    }

    // Authorize as admin
    function login_as_admin() {
        $.get('/cgi-bin/login?login=admin&password=admin', load_roles);
    }

    window.onload = load_roles;
% end
%= label_for roles => 'Roles'
<select name="roles" id="roles"></select>
<input type="button" value="Login as admin" onclick="login_as_admin()">

<br><br>

%= javascript begin
    function show(data) { alert(JSON.stringify(data)); }

    function register() {
        var role = $("#roles").val(),
            login = $("#login").val(),
            pass = $("#pass").val();

        $.ajax({ method: 'get', url: "/cgi-bin/register", data: {
            role: role, login: login, password: pass,
            name: 'test', lastname: 'test', email: 'test@test',
        }, success: show });
    }

    function login() {
        var login = $("#login").val(),
            pass = $("#pass").val();
        $.ajax({ method: 'get', 'url': '/cgi-bin/login', data: { login: login, password: pass }, success: show });
    }

    function list_users() {
        var $t = $("#users_table");
        $.get('/cgi-bin/users_list', function(data) {
            if (!data.ok)
                return;
            $t.before("<br><h1>Users list</h1>");
            $t.html("<tr><th>Name</th><th>Lastname</th><th>Login</th><th>Role</th><th>Email</th></tr>");
            for (var i = 0; i < data.count; ++i) {
                $t.append('<tr>' +
                    '<td>' + data.users[i].name + '</td>' +
                    '<td>' + data.users[i].lastname+ '</td>' +
                    '<td>' + data.users[i].login + '</td>' +
                    '<td>' + data.users[i].role + '</td>' +
                    '<td>' + data.users[i].email + '</td></tr>');
            }
        });
    }
% end

<input type="button" value="Register" onclick="register()">
<br>
<input type="button" value="Login" onclick="login()">
<br>
<input type="button" value="Logout" onclick="$.get('/cgi-bin/logout', show)">
<br>
<input type="button" value="List users" onclick="list_users()">
<br>
<table id="users_table"></table>
<br><br>

%= label_for districts => 'Query districts'
%= input_tag districts => '', id => 'districts_q'
%= javascript begin
    function districts() {
        var $d = $("#districts_table"),
            $s = $("#dstr_sel"),
            q = $("#districts_q").val();
        if (q)
            q = "?q=" + q;
        $.get('/cgi-bin/districts' + q, function (data) {
            $d.before("<br><h1>Districts list</h1>");
            $d.html("<tr><th>Id</th><th>Name</th></tr>");
            $s.html("");
            if (!data.ok)
                return;
            for (var i = 0; i < data.count; ++i) {
                $s.append('<option value="' + data.districts[i].id + '">' + data.districts[i].name + '</option>');
                $d.append('<tr>' +
                    '<td>' + data.districts[i].id + '</td>' +
                    '<td>' + data.districts[i].name + '</td></tr>');
            }
        });
    }
% end

<input type="button" value="Show districts" onclick="districts()">
<br>
<table id="districts_table"></table>
<br><br>

%= label_for districts_s => 'Select district'
<select name="districts_s" id="dstr_sel"></select><br>
<br>
%= label_for companies => 'Query companies'
%= input_tag companies => '', id => 'company_q'
<input type="button" value="Show companies" onclick="companies()">
<br>
<table id="companies_table"></table>
<br><br>
%= label_for companies_s => 'Select company'
<select name="companies_s" id="company_sel"></select><br>
<br>

%= javascript begin
    function companies() {
        var $d = $("#companies_table"),
            $s = $("#company_sel"),
            d = $("#dstr_sel").val(),
            q = $("#company_q").val();
        var qq = "";
        if (q)
            qq += "?q=" + q;
        if (d)
            qq += (qq == "" ? "?" : "&") + "district=" + d;

        $.get('/cgi-bin/companies' + qq, function (data) {
            $d.before("<br><h1>Companies list</h1>");
            $d.html("<tr><th>District</th><th>Id</th><th>Name</th></tr>");
            $s.html("");
            if (!data.ok)
                return;
            for (var i = 0; i < data.count; ++i) {
                $s.append('<option value="' + data.companies[i].id + '">' + data.companies[i].name + '</option>');
                $d.append('<tr>' +
                    '<td>' + data.companies[i].district + '</td>' +
                    '<td>' + data.companies[i].id + '</td>' +
                    '<td>' + data.companies[i].name + '</td></tr>');
            }
        });

    }
% end

%= label_for buildings => 'Query buildings'
%= input_tag buildings => '', id => 'building_q'
<input type="button" value="Show buildings" onclick="buildings()">
<br>
<table id="buildings_table"></table>
<br><br>
%= label_for buildings_s => 'Select building'
<select name="buildings_s" id="buildings_sel"></select><br>
<br>

%= javascript begin
    function buildings() {
        var $d = $("#buildings_table"),
            $b = $("#buildings_sel"),
            c = $("#company_sel").val(),
            d = $("#dstr_sel").val(),
            q = $("#building_q").val();
        var qq = "";
        if (q)
            qq += "?q=" + q;

        if (d && !c)
            qq += (qq == "" ? "?" : "&") + "district=" + d;
        else if (c)
            qq += (qq == "" ? "?" : "&") + "company=" + c;

        $.get('/cgi-bin/buildings' + qq, function (data) {
            $d.before("<br><h1>Buildings list</h1>");
            $d.html("<tr><th>District</th><th>Company</th><th>Id</th><th>Name</th></tr>");
            $b.html("");
            if (!data.ok)
                return;
            for (var i = 0; i < data.count; ++i) {
                $b.append('<option value="' + data.buildings[i].id + '">' + data.buildings[i].name + '</option>');
                $d.append('<tr>' +
                    '<td>' + data.buildings[i].district + '</td>' +
                    '<td>' + data.buildings[i].company + '</td>' +
                    '<td>' + data.buildings[i].id + '</td>' +
                    '<td>' + data.buildings[i].name + '</td></tr>');
            }
        });

    }
% end
